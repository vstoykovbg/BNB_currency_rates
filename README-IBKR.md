# Автоматична обработка на данните от Interactive Brokers

ⓘ За да работят коректно трябва да изтеглите заедно с тях и някои други важни файлове и директории с файлове и те да са в текущата директория. Най-лесно е да изтеглите всичко в zip файл - от бутона Code се отваря меню, от което избирате Download ZIP (или от [този линк](https://github.com/vstoykovbg/BNB_currency_rates/archive/refs/heads/main.zip)).

(Уточнение: Електронните таблици за LibreOffice Calc работят без Питон, те си имат всичко необходимо в тях, може да свалите само таблицата, която ви трябва. Ползват макрос на Бейсик, не Питон.)

[Линк към главното README на хранилището.](README.md)

## Автоматична обработка на дивидентите от Interactive Brokers (от файлове с формат CSV)

Скриптът `process_IBKR_dividends.py` работи само с файлове `.csv` (не се опитвайте да го ползвате с `.pdf`, няма да работи).

(Скриптът `ibkr_ods_exporter.py`, който разглеждам по-надолу, също обработва дивиденти, но приема само файлове `.xml` и записва обработените данни в `.ods` файл.)

Скриптът обработва само информацията за дивидентите и удържаните данъци върху дивидентите.

    $ ./process_IBKR_dividends.py 
    Usage:

    Single file mode:

      process_IBKR_dividends.py input.csv output.csv [mode=nap-autopilot|table|sheet] [input=one]

    Two files mode (with separate Financial Instrument Information):

      process_IBKR_dividends.py input.csv input_FII.csv output.csv [mode=nap-autopilot|table|sheet] [input=two]

    Options:

      mode=      Output format: nap-autopilot, table, sheet
      input=     Input mode: 'one' (single file) or 'two' (separate FII file)

Скриптът приема два типа справки за дивидентите - Activity Statement (желателно със секция Financial Instrument Information за да излязат на изхода имената на компаниите, а не тикерите) и Flex Query (Cash Transactions).

Когато се ползва Flex Query без да се зададе втори файл, съдържащ секция Financial Instrument Information, на изхода ще излязат тикерите вместо имената на компаниите.

По подразбиране извежда на изхода данни във формата за nap-autopilot, но може да зададете чрез `mode=table` или `mode=sheet` по-подробни данни.

Желателно е да подавате Activity Statement, който е тип custom statement само с необходимите раздели (Combined Dividends, Withholding Tax, Financial Instrument Information).

Ако при заявката за Activity Statement изберете за Period "Annual" в получения `.csv` файл ще липсва секцията Financial Instrument Information и в резултат няма да имате имена на компаниите на изхода (ще излязат вместо тях тикерите). Правилният начин е да изберете за Period "Custom Date Range". Ще ви излезе предупреждение за дублирани секции, но това не е от значение (по някаква приумица има по две секции от един и същи тип). Проблем с дублираните секции има само ако те се отнасят до дивидентите и удържаните данъци върху тях (тогава ще излезе допълнително съобщение за грешка, което ви предупреждава за дублирането).

С моите данни работи и с двата типа справки. Но за да сте сигурни може да го пробвате с двата типа справки и да сравните резултатите. Когато работи с данни тип Flex Query намирането на правилните удържани данъци работи по-прецизно, защото има идентификатор `ActionID`, който недвусмислено указва кои данъци за кои дивиденти се отнасят. Но за да излязат имената на компаниите трябва да захраните скрипта с втори файл, който е тип Activity Statement и съдържа секция Financial Instrument Information.

Ако се объркате да полвате custom statement с всички възможни раздели скриптът ще засече дублирани данни и ще изведе съобщение за грешка (данните на изхода ще са грешни). Причината е, че ако изберете всички възможни раздели се получава дублиране на данните.

Правилният начин да извадите Flex Query е като изберете Cash Transactions. Не се опитвайте да избирате неща, в които има Dividends в името (защото там няма данни за изплатените дивиденти, а данни за начислените дивиденти са безполезни за данъчни цели). Контраинтуитивно данните за изплатените дивиденти са в Cash Transactions.

### Как се генерира Flex Query с данни за дивидентите и удържаните данъци върху тях:

Влезте във Flex Queries, в дясно от Activity Flex Query натискате знака +, на Query Name пишете някакво име на справката, избирате Cash Transactions.

Важни са тези раздели:

* Dividends
* Payment in Lieu of Dividends
* Withholding Tax

Важни са тези колони с данни:

* CurrencyPrimary
* Description
* ISIN
* IssuerCountryCode
* SettleDate
* Amount
* Type

За по-лесно може да оставите всички избрани по подразбиране раздели (но все пак внимавайте важните раздели да са избрани). За колони може да изберете `[x] Select all` за да не се занимавате да избирате една по една важните колони.

## Автоматична обработка на данните за капиталовата печалба, отворените позиции (притежаваните към 31 декември акции), дивидентите и лихвите (от файлове с формат XML към файл с формат ODS)

    $ ./ibkr_ods_exporter.py -h
    usage: ibkr_ods_exporter.py [-h] [--convert-date] xml_dir
    
    positional arguments:
      xml_dir         Path to directory containing XML files
    
    options:
      -h, --help      show this help message and exit
      --convert-date  Convert dates to Sofia timezone (DD.MM.YYYY HH:MM:SS format)

Скриптът обработва всички `.xml` файлове от зададената директория и записва резултатите във файл `ibkr_output.ods` (в същата зададена директория). Ако вече има такъв файл скриптът извежда съобщенеи за грешка и спира (не обработва данните).

Във файла `ibkr_output.ods` може да бъдат създадени тези раздели (sheets):

* Realized Trades - данни за цените на придобиване, продажните цени, печалбите и загубите.
* Open Positions - данни за отворените позиции към дата `to_date` (за да ползвате за деклариране на притежаваните акции към 31 декември трябва тази дата да е 31 декември или друга дата, на която отворените позиции са същите като на 31 декември). Датата `to_date` е датата, която сте избрали при генериране на справката за отворените позиции.
* dividends-nap-autopilot - данните за дивидентите, подходящи за експортиране към `.csv` файл за `nap-autopilot`.
* dividends-sheet - данни за дивидентите в по-подробен формат.
* dividends-table - данни за дивиднентите във формат като за ръчно преписване в данъчната декларация (ако може да ползвате `nap-autopilot` е по-добре да го ползвате вместо ръчно да преписвате).
* Interest - данни за лихвите.
* Totals - обобщени данни за капиталовата печалба и лихвите.

!!! Не е възможно да вземете наготово данните за капиталовата печалба от Totals и да ги препишете в таблица 2 на приложение 5. Причината е, че някои редове от `Realized Trades` може да се отнасят за продажби на регулиран пазар по мисъла на закона. Трябва да разгледате всички редове един по един и да прецените кои редове да махнете (защото загубите и печалбите, реализирани на регулиран пазар по смисъла на закона, не участват във формиране на данните за капиталовата печалба). Тоест ако включите в изчисленията ред, който се отнася до загуба, реализирана на регулиран пазар, и този ред повлияе на крайния резултат, това ще доведе до деклариране на по-малък данък от реално дължимия, което е нарушение.

[Линк към главното README на хранилището.](README.md)
